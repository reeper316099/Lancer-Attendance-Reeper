{% extends "base.html" %}

{% block title %}Reports - RFID Attendance{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block body %}
<div class="admin-container">
    <nav class="admin-nav">
        <h1>Reports & Analytics</h1>
        <div class="nav-links">
            <a href="/admin">Dashboard</a>
            <a href="/register">Register Cards</a>
            <a href="/reports" class="active">Reports</a>
            <a href="/display" target="_blank">Live Display</a>
            <a href="/logout">Logout</a>
        </div>
    </nav>
    
    <div class="admin-content">
        <!-- Date Selector -->
        <div class="section">
            <div class="date-selector">
                <label>Select Date:</label>
                <input type="date" id="reportDate" onchange="loadDailyReport()">
                <button class="btn-secondary" onclick="loadWeeklyReport()">Last 7 Days</button>
                <button class="btn-secondary" onclick="exportReport()">Export CSV</button>
            </div>
        </div>
        
        <!-- Summary Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Visits</h3>
                <div class="stat-value" id="totalVisits">0</div>
            </div>
            <div class="stat-card">
                <h3>Unique Visitors</h3>
                <div class="stat-value" id="uniqueVisitors">0</div>
            </div>
            <div class="stat-card">
                <h3>Average Duration</h3>
                <div class="stat-value" id="avgDuration">0 min</div>
            </div>
            <div class="stat-card">
                <h3>Peak Usage Day</h3>
                <div class="stat-value" id="peakDay">-</div>
            </div>
        </div>
        
        <!-- Charts -->
        <div class="charts-container">
            <div class="chart-card">
                <h3>Weekly Attendance Trend</h3>
                <canvas id="weeklyChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Daily Visits by Hour</h3>
                <canvas id="hourlyChart"></canvas>
            </div>
        </div>
        
        <!-- Detailed Records -->
        <div class="section">
            <h2>Detailed Check-in Records</h2>
            <div class="table-controls">
                <input type="text" id="searchRecords" placeholder="Search records..." onkeyup="filterRecords()">
            </div>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Student ID</th>
                            <th>Check-In</th>
                            <th>Check-Out</th>
                            <th>Duration</th>
                            <th>Auto Checkout</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <tr><td colspan="6" class="empty">Select a date to view records</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- User History Lookup -->
        <div class="section">
            <h2>Individual User History</h2>
            <div class="user-lookup">
                <select id="userSelect" onchange="loadUserHistory()">
                    <option value="">Select a user...</option>
                </select>
                <div id="userHistoryContainer" style="display: none;">
                    <h3 id="userName"></h3>
                    <div class="user-stats">
                        <span>Total Visits: <strong id="userTotalVisits">0</strong></span>
                        <span>Total Time: <strong id="userTotalTime">0 hrs</strong></span>
                        <span>Avg Duration: <strong id="userAvgDuration">0 min</strong></span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Check-In</th>
                                    <th>Check-Out</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="userHistoryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let weeklyChart = null;
let hourlyChart = null;
let allRecords = [];
let weeklyData = [];

// Set default date to today
document.getElementById('reportDate').valueAsDate = new Date();

async function loadUsers() {
    const response = await fetch('/api/users');
    const users = await response.json();
    
    const select = document.getElementById('userSelect');
    select.innerHTML = '<option value="">Select a user...</option>' +
        users.map(u => `<option value="${u.id}">${u.name} (${u.student_id})</option>`).join('');
}

async function loadDailyReport() {
    const date = document.getElementById('reportDate').value;
    const response = await fetch(`/api/reports/daily?date=${date}`);
    const data = await response.json();
    
    document.getElementById('totalVisits').textContent = data.total_visits;
    document.getElementById('uniqueVisitors').textContent = data.unique_visitors;
    document.getElementById('avgDuration').textContent = data.average_duration_minutes.toFixed(0) + ' min';
    
    allRecords = data.checkins;
    renderRecords();
    updateHourlyChart(data.checkins);
}

async function loadWeeklyReport() {
    const response = await fetch('/api/reports/weekly');
    weeklyData = await response.json();
    
    // Find peak day
    if (weeklyData.length > 0) {
        const peak = weeklyData.reduce((max, day) => 
            day.total_visits > max.total_visits ? day : max
        );
        document.getElementById('peakDay').textContent = new Date(peak.date).toLocaleDateString('en-US', {weekday: 'short'});
    }
    
    updateWeeklyChart();
}

function updateWeeklyChart() {
    const ctx = document.getElementById('weeklyChart').getContext('2d');
    
    if (weeklyChart) weeklyChart.destroy();
    
    weeklyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: weeklyData.map(d => new Date(d.date).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})),
            datasets: [{
                label: 'Total Visits',
                data: weeklyData.map(d => d.total_visits),
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                tension: 0.4
            }, {
                label: 'Unique Visitors',
                data: weeklyData.map(d => d.unique_visitors),
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {stepSize: 1}
                }
            }
        }
    });
}

function updateHourlyChart(records) {
    const hourCounts = new Array(24).fill(0);
    
    records.forEach(record => {
        const hour = new Date(record.check_in_time).getHours();
        hourCounts[hour]++;
    });
    
    const ctx = document.getElementById('hourlyChart').getContext('2d');
    
    if (hourlyChart) hourlyChart.destroy();
    
    hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Check-ins by Hour',
                data: hourCounts,
                backgroundColor: '#FF9800',
                borderColor: '#F57C00',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {stepSize: 1}
                }
            }
        }
    });
}

function renderRecords() {
    const tbody = document.getElementById('recordsBody');
    
    if (allRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No records found</td></tr>';
        return;
    }
    
    tbody.innerHTML = allRecords.map(r => `
        <tr>
            <td>${r.name}</td>
            <td>${r.student_id}</td>
            <td>${formatDateTime(r.check_in_time)}</td>
            <td>${r.check_out_time ? formatDateTime(r.check_out_time) : '<em>Still in</em>'}</td>
            <td>${r.check_out_time ? calculateDuration(r.check_in_time, r.check_out_time) : '-'}</td>
            <td>${r.auto_checkout ? 'âœ“ Auto' : ''}</td>
        </tr>
    `).join('');
}

function filterRecords() {
    const search = document.getElementById('searchRecords').value.toLowerCase();
    const rows = document.querySelectorAll('#recordsBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
    });
}

async function loadUserHistory() {
    const userId = document.getElementById('userSelect').value;
    if (!userId) {
        document.getElementById('userHistoryContainer').style.display = 'none';
        return;
    }
    
    const response = await fetch(`/api/reports/user/${userId}`);
    const history = await response.json();
    
    // Get user info
    const usersResponse = await fetch('/api/users');
    const users = await usersResponse.json();
    const user = users.find(u => u.id == userId);
    
    document.getElementById('userName').textContent = `${user.name} (${user.student_id})`;
    document.getElementById('userTotalVisits').textContent = history.length;
    
    // Calculate total time
    let totalMinutes = 0;
    history.forEach(h => {
        if (h.duration_minutes) totalMinutes += h.duration_minutes;
    });
    
    document.getElementById('userTotalTime').textContent = (totalMinutes / 60).toFixed(1);
    document.getElementById('userAvgDuration').textContent = history.length > 0 ? 
        (totalMinutes / history.length).toFixed(0) : 0;
    
    const tbody = document.getElementById('userHistoryBody');
    tbody.innerHTML = history.map(h => `
        <tr>
            <td>${new Date(h.check_in_time).toLocaleDateString()}</td>
            <td>${formatTime(h.check_in_time)}</td>
            <td>${h.check_out_time ? formatTime(h.check_out_time) : '-'}</td>
            <td>${h.duration_minutes ? h.duration_minutes + ' min' : '-'}</td>
        </tr>
    `).join('');
    
    document.getElementById('userHistoryContainer').style.display = 'block';
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
    });
}

function calculateDuration(start, end) {
    const diff = new Date(end) - new Date(start);
    const minutes = Math.floor(diff / 60000);
    if (minutes < 60) return `${minutes} min`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
}

function exportReport() {
    const date = document.getElementById('reportDate').value;
    let csv = 'Name,Student ID,Email,Check-In,Check-Out,Duration (min),Auto Checkout\n';
    
    allRecords.forEach(r => {
        const duration = r.check_out_time ? 
            Math.floor((new Date(r.check_out_time) - new Date(r.check_in_time)) / 60000) : '';
        csv += `"${r.name}","${r.student_id}","${r.email}","${r.check_in_time}","${r.check_out_time || ''}","${duration}","${r.auto_checkout ? 'Yes' : 'No'}"\n`;
    });
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance_report_${date}.csv`;
    a.click();
}

// Initial load
loadUsers();
loadDailyReport();
loadWeeklyReport();
</script>
{% endblock %}
